# clean up the system before test starts, remove the latest applied ptf group if exists
- name: Clean up actions
  block:
  - name: Get the current PTF group level of "group_name" on {{ansible_ssh_host}}
    ibm.power_ibmi.ibmi_sql_query:
      sql: select * from SYSTOOLS.GROUP_PTF_CURRENCY where PTF_GROUP_ID='{{group_name}}'
    register: current

  - name: Get the latest PTF group level from PSP website
    ibm.power_ibmi.ibmi_fix_group_check:
      groups: '{{group_name}}'
    register: group_check_result

  - name: Remove the PTF group level info if matches, skip cleanup elsewise
    ibm.power_ibmi.ibmi_cl_command:
      cmd: "DLTPTFGRP PTFGRP({{group_name}})"
    register: dltptfgrp
    when: current.row_count == 1 and current.row[0]['PTF_GROUP_LEVEL_INSTALLED'] == group_check_result.group_info[0]['ptf_group_level']
    failed_when: dltptfgrp.rc != 0
